<form id="depForm" class="flex flex-col items-center justify-center w-full h-auto px-5 py-5">
    <input id="tituloD" type="text" placeholder="Título" class="border-2 border-gray-200 w-full rounded-md p-2 mb-3 text-gray-800 bg-white" required/>
    <textarea id="descripcionD"
        placeholder="Descripción" 
        class="border-2 border-gray-200 rounded-md p-2 mb-3 text-gray-800 bg-white w-full min-h-32"
        required></textarea>
    <label class="mb-2 text-white font-black">Imagen del departamento</label>
    <input id="imagenD" type="file" accept="image/*" class="file:bg-blue-500 file:text-white file:font-semibold file:border-none file:rounded file:px-4 file:py-2 text-gray-200 mb-4 file:cursor-pointer"/>
    <input id="nombreDL" type="text" placeholder="Nombre del link" class="border-2 border-gray-200 w-full rounded-md p-2 mb-3 text-gray-800 bg-white"/>
    <input id="urlD" type="text" placeholder="url" class="border-2 border-gray-200 w-full rounded-md p-2 mb-5 text-gray-800 bg-white"/>
    <label class="mb-2 text-white font-black">Seleccione Pdf o Documento word</label>
    <input id="archivoD" type="file" accept=".pdf, .doc, .docx" class="file:bg-blue-500 file:text-white file:font-semibold file:border-none file:rounded file:px-4 file:py-2 text-gray-200 mb-4 file:cursor-pointer"/>
    <div class="flex justify-center items-center">
        <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 cursor-pointer">Agregar Departamento</button>
        <a class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 cursor-pointer ml-3" href="/DepPage">
            Ver
        </a>
    </div>
</form>

<script>
    const URLBACK = import.meta.env.PUBLIC_BACKEND_URL || 'http://localhost:4321'
    
    async function subirDep(nuevoDep: FormData) {
        const response = await fetch(`${URLBACK}/departamento/`, {
            method: 'POST',
            credentials: 'include',
            body: nuevoDep
        })

        if (!response.ok) {
            throw new Error('Error al subir departamento')
        }

        const departamentoCreado = await response.json()
        console.log('Departamento subido exitosamente:', departamentoCreado)
    }

    document.addEventListener('DOMContentLoaded', () => {
        const formulario = document.querySelector('#depForm') as HTMLFormElement

        formulario.addEventListener('submit', async (event) => {
            event.preventDefault()

            const titulo = (document.querySelector('#tituloD') as HTMLInputElement).value
            const descripcion = (document.querySelector('#descripcionD') as HTMLTextAreaElement).value

            const imagenInput = document.querySelector('#imagenD') as HTMLInputElement
            const file = document.querySelector('#archivoD') as HTMLInputElement
            const urlInput = document.querySelector('#urlD') as HTMLInputElement
            const nombreLinkInput = document.querySelector('#nombreDL') as HTMLInputElement

            const imagen = imagenInput.files?.[0]
            const link_file = file.files?.[0]
            const link_url = urlInput.value.trim()
            const titulo_link = nombreLinkInput.value.trim()

            if (!imagen) {
                alert('Debes subir una imagen')
                return;
            }

            const nuevoDep = new FormData()
            nuevoDep.append('titulo', titulo)
            nuevoDep.append('descripcion', descripcion)
            nuevoDep.append('imagen', imagen)

            if (titulo_link !== "") {
                nuevoDep.append('titulo_link', titulo_link)
                if (link_file && link_url) {
                    alert('Solo puedes agregar un archivo o una URL, no ambos.')
                    return
                }

                if (link_file) {
                    nuevoDep.append('link_file', link_file)
                } else if (link_url) {
                    nuevoDep.append('link_url', link_url)
                } else {
                    alert('Si agregas un nombre de link, debes subir un archivo o proporcionar una URL.')
                    return
                }
            }

            try {
                await subirDep(nuevoDep)
                alert('Departamento subido correctamente.')
                formulario.reset()
            } catch (error) {
                console.error(error)
                alert('Error al subir Departamento.')
            }
        })
    })

</script>