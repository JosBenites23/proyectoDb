<div>
    <div id="contenedor-empresas"></div>
</div>

<script>

    declare global {
        interface Window {
            eliminarEmpresa: (id: number) => Promise<void>
        }
    }

    const URL = import.meta.env.PUBLIC_BACKEND_URL || 'http://localhost:8081'
    interface Empresa {
        id: number
        contenido: string
        imagen: string
    } 
    
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            await verificarToken()
            cargarEmpresas()
        } catch (error) {
            console.error('Error al cargar empresas:', error)
        }
    })

    
    async function cargarEmpresas(){
        const response = await fetch(`${URL}/company/`)
        const empresas:Empresa[] = await response.json()

        const contenedor = document.querySelector('#contenedor-empresas') as HTMLElement
        contenedor.innerHTML = ''

        empresas.forEach((empresa) => {
            const card = document.createElement('div')
            card.className = 'p-4 border rounded-lg shadow-md mb-4 bg-white'
            card.innerHTML = `
                <img src="${empresa.imagen}" alt="imagen de empresa" class="w-32 h-auto object-contain rounded-lg">
                ${tokenValido ? `<button onclick="eliminarEmpresa(${empresa.id})" class="bg-red-500 text-white px-4 py-2 rounded cursor-pointer hover:bg-red-800 transition duration-300 ease-in-out">Eliminar</button>` : ""}
            `;
            contenedor.appendChild(card)
        })
    }

    async function eliminarEmpresa(id: number) {
        console.log("Eliminando empresa con ID:", id)
        const response = await fetch(`${URL}/eliminar-empresa/${id}`, {
            method: 'DELETE',
            credentials: 'include' // Incluye cookies en la solicitud
        })

        if (response.ok) {
            alert('Empresa eliminada')
            cargarEmpresas() // Recargar las empresas
        } else {
            alert('Error al eliminar la empresa')
        }
    }

    window.eliminarEmpresa = eliminarEmpresa

    let tokenValido = false

    async function verificarToken() {
        try {
            const response = await fetch(`${URL}/protegida`, {
                credentials: 'include' // Incluye cookies en la solicitud
            })

            tokenValido = response.ok;
        } catch (error) {
            tokenValido = false
            console.error('Error al verificar el token:', error)
        }
    }
</script>
