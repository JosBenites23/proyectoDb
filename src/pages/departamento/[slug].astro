---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
const { slug } = Astro.params;

// Obtener datos del departamento
const res = await fetch(`http://9.0.1.247:8081/departamento/page-dep/${slug}`, {
  credentials: 'include'
});
if (!res.ok) {
  throw new Error('Departamento no encontrado');
}
type Link = {
  id: number;
  titulo_link: string;
  url: string;
  fecha_creacion?: string;
};

type Departamento = {
  id: number;
  titulo: string;
  descripcion: string;
  imagen: string;
  slug: string;
  links: Link[];
};

const departamento: Departamento = await res.json();
---

<Layout showMenu={false}>

    <section class="max-w-3xl mx-auto py-10 px-4 text-gray-200">
      <div class="flex flex-col items-center">
        <img src={departamento.imagen} alt={departamento.titulo} class="w-full max-w-md rounded-lg shadow-lg mb-6" />
        <h1 class="text-3xl font-bold mb-2">{departamento.titulo}</h1>
        <p class="mb-6">{departamento.descripcion}</p>
      </div>
    
      <ul class="space-y-2 mb-8">
        {departamento.links && departamento.links.length > 0 ? (
          departamento.links.map(link => (
            <li class="bg-blue-900/40 rounded px-4 py-2 flex flex-col md:flex-row md:items-center gap-2">
              <span class="font-medium">{link.titulo_link}</span>
              <a href={link.url} target="_blank" class="text-sky-300 underline break-all">{link.url}</a>
            </li>
          ))
        ) : (
          <li class="text-gray-400">No hay links para este departamento.</li>
        )}
      </ul>
    
      <form id="agregarLinkForm" data-id={departamento.id} style="display:none" class="bg-blue-900/30 rounded-lg p-4 flex flex-col gap-4" enctype="multipart/form-data">
      <h3 class="text-xl font-semibold mb-2">Agregar Link</h3>
      <input id="titulo_link" type="text" placeholder="Título del link" class="p-2 rounded bg-gray-800 text-gray-200" required />
      <input id="url" type="url" placeholder="URL del link" class="p-2 rounded bg-gray-800 text-gray-200"  />
      <label class="mb-2">Seleccione Manual o Documento</label>
      <input id="archivoD" type="file" accept=".pdf, .doc, .docx" class="file:bg-blue-500 file:text-white file:font-semibold file:border-none file:rounded file:px-4 file:py-2 text-gray-200 mb-4 file:cursor-pointer"/>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded cursor-pointer">Agregar</button>
      </form>
</section>


<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    // Validar token y mostrar el panel de agregar link
    async function verificarToken() {
      try {
        const response = await fetch('http://9.0.1.247:8081/protegida', {
          credentials: 'include'
        });
        if (response.ok) {
          document.getElementById('agregarLinkForm').style.display = '';
        }
      } catch (error) {
        // No mostrar el panel si hay error
      }
    }
    verificarToken();

    // Enviar el formulario de agregar link usando fetch
    const form = document.getElementById('agregarLinkForm');
    if (form) {
      const depId = form.getAttribute('data-id');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = new FormData();

        // Obtener los valores del formulario
        const titulo_link = form.querySelector('#titulo_link').value;
        const link_url = form.querySelector('#url').value;
        const link_file = form.querySelector('#archivoD').files[0];

        if (titulo_link !== "") {
          data.append('titulo_link', titulo_link);

          if (link_file && link_url) {
            alert('Solo puedes agregar un archivo o una URL, no ambos.');
            return;
          } else if (link_file) {
            data.append('link_file', link_file);
          } else if (link_url) {
            data.append('link_url', link_url);
          } else {
            alert('Si agregas un nombre de link, debes subir un archivo o proporcionar una URL.');
            return;
          }
        }

        const res = await fetch(`http://9.0.1.247:8081/departamento/${depId}/agregar-link`, {
          method: 'POST',
          credentials: 'include',
          body: data
        });

        if (!res.ok) {
          alert('Link no se agregó');
          location.reload();
        } else {
          alert('Link agregado correctamente');
          location.reload();
        }
      });
    }
  });
</script>
</Layout>