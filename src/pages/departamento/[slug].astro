---
export const prerender = false
import Layout from '../../layouts/Layout.astro'
const { slug } = Astro.params

const URLBACKEND=import.meta.env.PUBLIC_BACKEND_URL || 'http://localhost'
// Obtener datos del departamento
const res = await fetch(`${URLBACKEND}/departamento/page-dep/${slug}`, {
  credentials: 'include'
})
if (!res.ok) {
  throw new Error('Departamento no encontrado')
}
type Link = {
  id: number
  titulo_link: string
  url: string
  fecha_creacion?: string
}

type Departamento = {
  id: number
  titulo: string
  descripcion: string
  imagen: string
  slug: string
  links: Link[]
}

const departamento: Departamento = await res.json()
---

<Layout showMenu={false}>

  <section class="w-full">
    <section class="max-w-3xl mx-auto py-10 px-4 text-gray-200">
      <div class="flex flex-col items-center" id="depInfo" data-id={departamento.id}>
        <h1 class="text-3xl font-bold mb-2">{departamento.titulo}</h1>
        <div class=" flex">
          <p id="depDesc"class="mb-6">{departamento.descripcion}</p>
          <button id="editDescBtn" style="display:none" class="ml-5 bg-yellow-400 text-black px-2 py-1 rounded flex items-center gap-1 text-sm cursor-pointer h-10 w-20 hover:bg-yellow-600 transition duration-200">
            ✏️ Editar
          </button>
        </div>
        <div class="flex">
          <img id="depImg" src={departamento.imagen} alt={departamento.titulo} class="w-full max-w-md rounded-lg shadow-lg mb-6" />
          <button id="editImgBtn" style="display:none" class="ml-5 bg-yellow-400 text-black px-2 py-1 rounded flex items-center gap-1 text-sm cursor-pointer h-10 w-20 hover:bg-yellow-600 transition duration-200">
            ✏️ Editar
          </button>
        </div>
      </div>
    
      <ul class="flex items-center flex-col gap-4 mb-8">
        {departamento.links && departamento.links.length > 0 ? (
          departamento.links.map(link => (
            <li id="link-item" data-link-id={link.id}>
              <a href={link.url} target="_blank" class="text-gray-200 font-medium hover:contrast-200 transition duration-200 cursor-pointer break-all bg-blue-900/40 rounded px-4 py-2 gap-2 text-center w-full h-auto">{link.titulo_link}</a>
              {}
            </li>
          ))
        ) : (
          <li class="text-gray-400">No hay links para este departamento.</li>
        )}
      </ul>
    
      <form id="agregarLinkForm" data-id={departamento.id} style="display:none" class="bg-blue-900/30 rounded-lg p-4 flex flex-col gap-4" enctype="multipart/form-data">
      <h3 class="text-xl font-semibold mb-2">Agregar Link</h3>
      <input id="titulo_link" type="text" placeholder="Título del link" class="p-2 rounded bg-gray-800 text-gray-200" required />
      <input id="url" type="url" placeholder="URL del link" class="p-2 rounded bg-gray-800 text-gray-200"  />
      <label class="mb-2">Seleccione Manual o Documento</label>
      <input id="archivoD" type="file" accept=".pdf, .doc, .docx" class="file:bg-blue-500 file:text-white file:font-semibold file:border-none file:rounded file:px-4 file:py-2 text-gray-200 mb-4 file:cursor-pointer"/>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded cursor-pointer">Agregar</button>
      </form>
    </section>
  </section>

<!--
  <script type="module">
    //const URLBACK=this.dataset.URLBACK
    const URLBACK = this.dataset.URLBACKEND
    console.log(URLBACK)
    document.addEventListener('DOMContentLoaded', () => {
      console.log("dom loaded")
      let esAdmin = false
  
      async function verificarToken() {
        try {
          console.log("verificando token")
          const response = await fetch(`${URLBACK}/protegida`, {
            credentials: 'include'
          });
          console.log("verificacion de token", response)
          if (response.ok) {
            esAdmin = true
            console.log("token valido")
            document.getElementById('agregarLinkForm').style.display = ''
          }
          mostrarBotonesEliminar()
          mostrarBotonesEditar()
        } catch (error) {
          esAdmin = false
        }
      }
      verificarToken()
  
      function mostrarBotonesEliminar() {
        if (!esAdmin) return
        document.querySelectorAll('#link-item').forEach((item) => {
          const linkId = item.getAttribute('data-link-id')
          if (!item.querySelector('.btn-eliminar-link')) {
            const btn = document.createElement('button')
            btn.textContent = 'Eliminar'
            btn.className = 'btn-eliminar-link bg-red-500 text-white px-3 py-1 rounded ml-2 hover:bg-red-700 transition duration-200 cursor-pointer mt-2'
            btn.onclick = async () => {
                const res = await fetch(`${URLBACK}/departamento/link/${linkId}`, {
                  method: 'DELETE',
                  credentials: 'include'
                })
                if (res.ok) {
                  alert('Link eliminado')
                  location.reload()
                } else {
                  alert('Error al eliminar el link')
                }
            }
            item.appendChild(btn)
          }
        })
      }
  
      const form = document.getElementById('agregarLinkForm')
      if (form) {
        const depId = form.getAttribute('data-id')
        form.addEventListener('submit', async (e) => {
          e.preventDefault()
          const data = new FormData()
  
          const titulo_link = form.querySelector('#titulo_link').value
          const link_url = form.querySelector('#url').value
          const link_file = form.querySelector('#archivoD').files[0]
  
          if (titulo_link !== "") {
            data.append('titulo_link', titulo_link)
  
            if (link_file && link_url) {
              alert('Solo puedes agregar un archivo o una URL, no ambos.')
              return
            } else if (link_file) {
              data.append('link_file', link_file)
            } else if (link_url) {
              data.append('link_url', link_url)
            } else {
              alert('Si agregas un nombre de link, debes subir un archivo o proporcionar una URL.')
              return
            }
          }
  
          const res = await fetch(`${URLBACK}/departamento/${depId}/agregar-link`, {
            method: 'POST',
            credentials: 'include',
            body: data
          })
  
          if (!res.ok) {
            alert('Link no se agregó')
            location.reload()
          } else {
            alert('Link agregado correctamente')
            form.reset()
            location.reload()
          }
        })
      }
    });
  </script>
   -->

</Layout>