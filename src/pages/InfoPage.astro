---
import Layout from "../layouts/Layout.astro"
---

<Layout>
    <section class="w-full">
        <section class="min-h-screen w-full mt-32 py-5 px-10 justify-items-center text-gray-200">
            <h1 class="text-2xl font-bold py-5 px-10">
                Sobre Nosotros
            </h1>
            
            <div class="grid lg:grid-cols-6 gap-5 p-3 w-full md:grid-cols-4 sm-grid-cols-1 ">
                <!-- Caja de texto grande -->
                <div class="bg-blue-900 col-span-3 h-auto w-full rounded-lg flex flex-col px-5 py-5">
                    <h3 class="text-center font-medium text-2xl">Historia</h3>
                    <p class="text-gray-200">Almacenes La Ganga empezó sus operaciones en 1983, abriendo su primer local en el sector de “La Bahía” en Guayaquil. Desde sus inicios, el local se especializó en la comercialización y venta de electrodomésticos de las mejores marcas a nivel mundial, ofreciendo como ventaja lo que ningún otro local daba: garantía en sus productos. Desde esta época, se popularizó su slogan <strong>“Precios de Bahía con Garantía”.</strong>
                    </br>
                    Con el pasar de los años, el crecimiento de la cadena fue intenso, llegando a estar en la mayoría de provincias del Ecuador. Hoy, Almacenes La Ganga cuenta con más de 130 locales en todo el país y busca continuar expandiéndose hasta abarcar cada rincón de nuestra patria. Con esfuerzo y tenacidad, la empresa ha alcanzado el liderazgo en un ambiente competitivo, destacando por sus productos y las mejores ofertas del mercado.</p>
                </div>
            
                <!-- Caja de imagen grande -->
                <div class="col-span-3 rounded-lg overflow-hidden flex justify-center items-center hover:scale-105 transition-transform duration-300 ease-in-out">
                    <img src="/images/local.webp" alt="Imagen de la sucursal" class="object-contain max-w-md h-auto rounded-2xl">
                </div>
            
                <!-- 3 cajas pequeñas debajo -->
                <div class="bg-blue-900 col-span-2 h-auto w-full rounded-lg flex flex-col items-center justify-center text-gray-200 py-5 px-5">
                    <h3 class="font-medium">Mision</h3>
                    <p >Somos una empresa líder que comercializa electrodomésticos, confiando en nuestros clientes y colaboradores, otorgando bienestar, comodidad y entretenimiento a los precios más bajos y con garantía.</p>
                </div>
            
                <div class="bg-blue-900 col-span-2 h-auto w-full rounded-lg flex flex-col items-center justify-center text-gray-200 py-5 px-5">
                    <h3 class="font-medium">Visión</h3>
                    <p >Ser la primera opción de compra de nuestros clientes y lograr que en cada hogar ecuatoriano haya un electrodoméstico de La Ganga.

                    </p>
                </div>

                <div class="bg-blue-900 col-span-2 h-auto w-full rounded-lg flex flex-col items-center justify-center text-gray-200 py-5 px-5">
                    <h3 class="font-medium mb-3">Valores</h3>
                    <ul class="text-center">
                        <li></li>
                        <li>Lealtad</li>
                        <li>Eficiencia</li>
                        <li>Honradez</li>
                        <li>Trabajo en Equipo</li>
                        <li>Respeto</li>
                        <li>Responsabilidad</li>
                    </ul>
                </div>
            </div>

            <footer class="flex flex-col items-center justify-center mt-10">
                <h2 class="text-2xl font-medium text-gray-200">Nuestras empresas</h2>
                <section id="contenedorEmpresas" class="flex items-center gap-4 p-4 overflow-hidden no-scrollbar relative w-1/2">
                    <!-- Aquí se cargarán las empresas --> 
                </section>
            </footer>
            
            
        </section>
    </section>

<script>
    declare global {
        interface Window {
            eliminarCo: (id: number) => Promise<void>;
        }
    }
    interface Empresa {
        id: number;
        contenido: string;
        imagen: string;
    }

    const contenedor = document.getElementById('contenedorEmpresas') as HTMLElement;
    let scrollAmount = 0;
    let scrollSpeed = 1;
    let isDragging = false;
    let startX = 0;
    let scrollLeft = 0;
    let autoScrollId: number;
    let resumeTimeout: number;
    const token = localStorage.getItem('token');

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const empresas = await cargarEmpresas();
            if (empresas.length >= 4) {
                duplicarContenido(); // Para efecto infinito
                autoScroll();
                setupDrag();
            }
        } catch (error) {
            console.error("Error al cargar empresas:", error);
        }
    });

    async function cargarEmpresas(): Promise<Empresa[]> {
        const response = await fetch('http://9.0.1.247:8090/company/');
        if (!response.ok) throw new Error('Error al obtener las empresas');

        const empresas: Empresa[] = await response.json();
        if (!contenedor) return [];

        contenedor.innerHTML = '';
        empresas.forEach(empresa => {
            const card = document.createElement('div');
            card.className = 'w-auto flex-shrink-0 rounded-lg shadow-lg hover:scale-110 transition duration-300 ease-in-out';
            card.innerHTML = `
                <a href="${empresa.contenido}" target="_blank" rel="noopener noreferrer">
                    <img src="${empresa.imagen}" alt="imagen de empresa" class="w-32 h-20 object-contain" />
                </a>
                ${token ? `<button onclick="eliminarCo(${empresa.id})" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-800 transition cursor-pointer">Eliminar</button>` : ''}
            `;
            contenedor.appendChild(card);
        });

        return empresas;
    }

    function duplicarContenido() {
        contenedor.innerHTML += contenedor.innerHTML; // Duplicamos el contenido para loop
    }

    function autoScroll() {
        scrollAmount += scrollSpeed;
        if (scrollAmount >= contenedor.scrollWidth / 2) {
            scrollAmount = 0; // Reinicia al llegar a la mitad (ya que está duplicado)
        }
        contenedor.scrollLeft = scrollAmount;
        autoScrollId = requestAnimationFrame(autoScroll);
    }

    function setupDrag() {
        contenedor.addEventListener('pointerdown', e => {
            isDragging = true;
            startX = e.pageX;
            scrollLeft = contenedor.scrollLeft;
            cancelAnimationFrame(autoScrollId);
            clearTimeout(resumeTimeout);
        });

        contenedor.addEventListener('pointermove', e => {
            if (!isDragging) return;
            const x = e.pageX;
            const walk = (startX - x); // Qué tanto se mueve
            contenedor.scrollLeft = scrollLeft + walk;
        });

        const stopDrag = () => {
            if (!isDragging) return;
            isDragging = false;
            resumeTimeout = setTimeout(() => autoScroll(), 1000);
        };

        contenedor.addEventListener('pointerup', stopDrag);
        contenedor.addEventListener('mouseleave', stopDrag);
    }

    async function eliminarCo(id: number) {
        const response = await fetch(`http://9.0.1.247:8090/eliminar-empresa/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            alert('empresa eliminada');
            location.reload(); // recarga todo para evitar problemas con contenido duplicado
        } else if (response.status === 401) {
            alert('Sesión expirada. Por favor vuelve a iniciar sesión.');
            localStorage.removeItem('token');
            location.reload();
        } else {
            alert('Error al eliminar empresa');
        }
    }

    window.eliminarCo=eliminarCo

</script>


        
</Layout>
